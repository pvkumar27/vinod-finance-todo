name: Daily Task Notifications (8:00 AM CT)

on:
  schedule:
    - cron: '0 13 * * *'  # 8:00 AM Central Time (13:00 UTC)
  workflow_dispatch:  # Allow manual trigger

jobs:
  trigger-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger notification function
        run: |
          # Send both email and push notifications
          # URL encode the API key to handle special characters
          API_KEY=$(echo -n "${{ secrets.NOTIFICATION_API_KEY }}" | perl -MURI::Escape -ne 'print uri_escape($_)')
          RESPONSE=$(curl -X POST "https://us-central1-${{ secrets.FIREBASE_PROJECT_ID }}.cloudfunctions.net/sendDailyTaskReminders?key=${API_KEY}&sendPush=true" -s)
          echo "Function response: $RESPONSE"
          if [[ "$RESPONSE" == *"Sent notifications"* || "$RESPONSE" == *"No tasks due today"* ]]; then
            echo "✅ Notifications processed successfully"
          else
            echo "❌ Notification may have failed: $RESPONSE"
          fi